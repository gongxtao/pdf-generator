## v1.0.2 需要完成的需求

## 需求文档：css-to-webp 工具页面

### 1. 项目背景与目标
**背景**：  
css-to-webp 是一个独立的前端工具页面，旨在帮助设计师和开发者快速将 CSS 样式（通过选择模板或自定义输入）应用于固定文本内容，生成符合 CSS 样式规范的 HTML 页面，并转换为 WebP 图片，预览后自动上传到 Cloudflare R2，获取公开 URL。页面通过调用系统提供的 API（`getAllTemplates`, `/api/generate-html`, `/api/upload-webp`）实现动态功能，UI 风格与 EditorView 一致，技术栈为 React。

**目标**：  
- 提供直观交互：顶部模板列表（按类别分组）、左侧 CSS 编辑器、右侧预览与控制。  
- 确保 WebP 高质量（<5MB，支持透明/动画），Cloudflare R2 上传成功率 100%。  
- 用户场景：用户选择“简历”模板，编辑 CSS，生成 HTML（含固定简历文本），预览 WebP，确认后自动上传到 R2，获取 URL。

**目标用户**：设计师/开发者，需快速生成样式化页面图片并上传，用于设计资产或 Web 集成。

---

#### 2. 功能需求
##### 2.1 模板选择
- **位置**：页面顶部，展示模板列表。  
- **数据来源**：调用 `getAllTemplates` 函数，获取 JSON 数组。  
- **JSON 格式**：  
  ```json
  {
    "id": string,              // 唯一标识，e.g., "resume_001"
    "category": string,        // 模板类型分组，e.g., "简历", "报告"
    "title": string,           // 模板名称，e.g., "简约简历"
    "description": string,     // 模板描述，e.g., "适合专业简历的样式"
    "image_url": string,       // 缩略图 URL，e.g., "https://r2.example.com/thumbnail.jpg"
    "alt_text": string,        // 缩略图描述，e.g., "简历模板预览"
    "template_content": string, // CSS 样式代码，e.g., ".template { background: #fff; padding: 20px; }"
    "display_order": int,      // 显示顺序，e.g., 1
    "source": string,          // 来源，e.g., "system"
    "header_file": null,       // 未使用，忽略
    "footer_file": null        // 未使用，忽略
  }
  ```  
- **数量**：动态，由 JSON 数组大小决定（预计 5-20 个模板）。  
- **展示形式**：  
  - 横向卡片列表（显示 `title`, `image_url`，悬浮显示 `description`）。  
  - 按 `category` 分组（标签页切换，如 “简历”“报告”）。  
  - 按 `display_order` 排序，支持横向滚动。  
- **交互**：  
  - 点击模板，自动填充左侧 CSS 编辑器（`template_content`）和只读文本区域（固定文本）。  
  - 默认选择：首个模板（`display_order: 1`）。  
  - 刷新按钮：重新调用 `getAllTemplates` 更新列表。  

##### 2.2 CSS 输入
- **位置**：左侧，提供代码编辑器。  
- **功能**：  
  - 支持 CSS 语法高亮、自动补全、错误提示（e.g., 无效属性）。  
  - 初始化：加载模板 CSS（`template_content`）或空（自定义模式）。  
  - 支持现代 CSS：Flexbox, Grid, 渐变, 阴影, 变换, 动画 (@keyframes)。  
- **模式切换**：  
  - 模板模式：显示模板 CSS（`template_content`），用户可修改。  
  - 自定义模式：清空 CSS，用户自由输入。  
  - 切换方式：单选按钮（“模板 CSS”/“自定义 CSS”）。  
- **验证**：实时检查语法，标记错误（红波浪线）。  

##### 2.3 文本内容
- **位置**：左侧，CSS 编辑器下方，只读文本区域。  
- **内容**：固定文本，由模板 `category` 决定，不可修改，格式为 JSON：  
  ```json
  {
    "title": string,  // 标题，<100 字符，e.g., "John Doe"（简历）, "Annual Report"（报告）
    "body": string   // 正文，<500 字符，e.g., "Software Engineer\nExperience..."（简历）
  }
  ```  
- **映射规则**（由系统生成）：  
  - `category: "简历"`：固定文本如 `{ title: "John Doe", body: "Software Engineer\nExperience: ABC Corp..."}`。  
  - `category: "报告"`：固定文本如 `{ title: "Annual Report 2025", body: "Summary: Sales increased...", image: null }`。  
  - 其他 `category`：类似逻辑，系统预定义固定文本。  
- **显示**：  
  - 标题加粗，正文支持换行，图片 URL 显示为缩略图（若存在）。  
  - 清晰排版，区分字段（e.g., “标题: [title]”“正文: [body]”）。  
- **验证**：确保文本非空，图片 URL 合法（http(s)://）。  

##### 2.4 生成与转换
- **触发**：点击“生成图片”按钮。  
- **流程**：  
  - 调用 `/api/generate-html`。  
  - 返回：HTML 字符串。  
  - 渲染 HTML（iframe，隔离样式），转换为 WebP（高保真）。  
- **WebP 转换**：  
  - 配置：  
    - 尺寸：默认 800x600px，可输入（100-2000px）。  
    - 质量：80% 默认（0-100% 滑块，步进 10%）。  
    - 背景：透明（默认）/白色（切换）。   
- **预览**：  
  - 右侧显示 WebP 图片，支持缩放（50%-200%）、全屏查看。  
  - 失败提示：toast（“API 返回无效 HTML”或“转换失败”）。  

##### 2.5 上传确认
- **流程**：  
  - 预览后，显示“确认上传”按钮。  
  - 用户点击确认，自动调用 `/api/upload-webp`（POST 参数：WebP Blob + 文件名，如 `style_{timestamp}.webp`）。  
  - 对象存储：Cloudflare R2，返回公开 URL（e.g., “https://r2.example.com/style_123.webp”）。  
- **反馈**：  
  - toast（“上传成功，URL: [链接]”）。  
  - 提供选项：复制 URL、下载本地备份（`style_{timestamp}.webp`）。  
- **存储**：Cloudflare R2，私有存储，公开 URL 临时（默认 7 天）。  

##### 2.6 AI 辅助（可选）
- **功能**：  
  - “AI 优化”按钮，调用 `/api/generate-html` 预览（输入当前 CSS + 固定文本）。  
  - 返回建议 CSS，注入编辑器（用户可改）。  
- **位置**：左侧，CSS 编辑器下方。  

---

#### 3. UI/UX 设计
##### 3.1 页面布局
- **整体**：  
  - 顶部：模板列表（横向卡片，按 `category` 分组）。  
  - 左侧（50%）：CSS 编辑器 + 只读文本显示。  
  - 右侧（50%）：预览 + 控制面板。  
  - 全屏高度（100vh），独立页面（URL 如 `/css-to-webp`）。  
- **顶部（模板列表）**：  
  - 横向卡片列表（显示 `title`, `image_url`，悬浮 `description`）。  
  - 分组：标签页按 `category`（e.g., “简历”“报告”），按 `display_order` 排序。  
  - 按钮：刷新模板（调用 `getAllTemplates`）。  
- **左侧（输入区）**：  
  - **CSS 编辑器**：400px 高度，可滚动，深色主题（Monaco Editor），支持模板/自定义切换（单选按钮）。  
  - **文本显示**：只读区域，显示固定文本（`category` 决定），格式清晰（标题加粗、正文换行、图片缩略图）。  
  - **按钮**：清空 CSS（自定义模式）、AI 优化（可选）。  
- **右侧（预览与控制）**：  
  - **生成区**：醒目“生成图片”按钮（绿色，圆角）。  
  - **预览区**：WebP 图片（800x600px，支持缩放/全屏）。  
  - **控制面板**：  
    - 尺寸：宽/高输入（100-2000px）。  
    - 质量：0-100% 滑块（默认 80%）。  
    - 背景：透明/白色（单选）。  
    - 确认上传按钮（绿色，自动触发 `/api/upload-webp`）。  
  - **底部**：历史记录（最近 5 次，显示 `title` + R2 URL，点击复制/重新上传）。  
- **顶部工具栏**：  
  - 帮助（Tooltip：“顶部选择模板或输入 CSS，点击生成图片，确认后上传到 R2”）。  
  - 主题切换（浅/深色，与 EditorView 一致）。  

##### 3.2 交互反馈
- **模板选择**：点击后填充 CSS（`template_content`）和文本（`category` 固定），预览更新（0.3s 动画），toast（“已切换至 [title]”）。  
- **CSS 输入**：实时校验，错误提示（红波浪线）。  
- **生成图片**：点击显示 Spinner（“AI 生成中...”），成功预览 WebP（<5s）。  
- **上传**：确认后自动上传，Spinner（“上传中...”），成功显示 R2 URL（可复制），toast（“上传成功”）。  
- **错误处理**：  
  - 模板加载失败：toast（“getAllTemplates 失败，重试”）。  
  - API 错误：toast（“/api/generate-html 失败，检查输入”）。  
  - 上传失败：toast（“R2 上传失败，重试”），提供本地下载。  

##### 3.3 响应式设计
- **桌面**：顶部模板列表，左右分栏（CSS 编辑器 + 预览）。  
- **移动端**：垂直布局（顶部模板，中间 CSS + 文本，底部预览），编辑器折叠，预览支持捏合缩放。  

##### 3.4 引导
- **首次加载**：Tooltip（“顶部选择模板或输入 CSS，点击生成图片，确认后上传到 R2”）。  
- **模板列表**：卡片显示 `image_url` 缩略图，悬浮 `description`。  
- **文本显示**：字段说明（e.g., “标题: [title]”“正文: [body]”）。  

---

#### 4. 输入/输出格式
##### 4.1 输入
- **模板**：  
  - `getAllTemplates` 返回 JSON：  
    ```json
    [{ id, category, title, description, image_url, alt_text, template_content: string, display_order, source, header_file, footer_file }, ...]
    ```  
  - `template_content`：纯 CSS 字符串（e.g., `.template { background: #fff; padding: 20px; }`）。  
- **CSS**：字符串（from `template_content` 或用户输入）。  
- **文本内容**：JSON，由 `category` 固定（系统生成）：  
  ```json
  { title: string, body: string }
  ``` 

##### 4.2 输出
- **HTML**：`/api/generate-html` 返回字符串（语义化，e.g., `<div class="template"><h1>Title</h1></div>`）。  
- **WebP**：Blob（MIME: image/webp，<5MB）。  
- **上传**：Cloudflare R2 URL（e.g., “https://r2.example.com/style_123.webp”）。  

##### 4.3 验证
- **模板**：`getAllTemplates` 非空，`template_content` 合法 CSS。  
- **文本**：非空，图片 URL 合法（http(s)://）。  
- **API**：`/api/generate-html` 返回 200 + HTML 字符串。  
- **WebP**：大小 <5MB，格式正确。  
- **上传**：`/api/upload-webp` 返回 R2 URL。  

---

#### 5. 边缘场景与约束
- **模板相关**：  
  - `getAllTemplates` 失败：提示“加载模板失败，重试”，回退自定义 CSS 模式。  
  - 模板为空：禁用生成，提示“请选择模板”。  
  - `template_content` 无效：提示“CSS 无效，选择其他模板”。  
- **API 相关**：  
  - `/api/generate-html` 超时（10s）：提示“API 超时，重试”。  
  - HTML 无效：回退默认 HTML（`<div>Error</div>`）。  
  - `/api/upload-webp` 失败：提示“R2 上传失败，重试”，提供本地下载，自动重试 1 次。  
- **CSS 复杂性**：  
  - 动画：支持 <10 帧 WebP，超限回退首帧，提示“动画过长”。  
  - 伪元素（:hover）：捕获静态状态，提示“动态效果不支持”。  
  - 媒体查询：默认桌面渲染，支持切换（375px 移动）。  
- **性能**：  
  - 模板加载：<1s。  
  - 生成（API + WebP）：<5s。  
  - R2 上传：<2s。  
  - 内存：<100MB。  
- **兼容性**：  
  - 浏览器：Chrome 120+, Edge, Firefox。  
  - Safari 15+：WebP 回退 PNG，提示“浏览器不支持 WebP”。  
- **安全性**：  
  - 输入：过滤 XSS（CSS）。  
  - API：HTTPS, R2 token 认证。  
  - 上传：R2 私有存储，URL 临时（默认 7 天）。  
- **约束**：  
  - HTML：<1MB。  
  - WebP：<5MB。  
  - 历史：本地存储 5 条。  

---

#### 6. 非功能需求
- **性能**：  
  - 模板加载：<1s。  
  - 预览：<300ms。  
  - 生成 + 上传：<7s。  
  - 内存：<100MB。  
- **安全性**：  
  - 输入：防 XSS（CSS）。  
  - API：HTTPS, R2 token 认证。  
  - 上传：R2 私有存储，URL 临时（7 天）。  
- **兼容性**：  
  - 浏览器：Chrome 120+, Edge, Firefox, Safari 15+（PNG 回退）。  
  - 响应式：桌面/移动。  
- **可访问性**：  
  - ARIA：按钮/编辑器。  
  - 键盘：Tab/Enter 支持。  
- **国际化**：  
  - 中文优先，英文支持（表单标签、提示）。  
