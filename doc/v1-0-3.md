# Word→HTML 样式模板提取页，新增加word-to-css页面

## 1. 背景与目标
在现有系统上线前，运营/开发者需要**快速生成大量统一格式的文档样式模板**。  
新增一页「Word→HTML 提取器」：  
- 上传 .docx（≤1 MB）→ 即时得到 **可复用的 CSS 模板** + **并排对比视图**  
- 还原率 ≥98 %；总耗时 <3 s；体积增量 ≤1.2 MB；不污染老代码。

---

## 2. 用户故事
| 角色 | 愿望 | 验收标准 |
|---|---|---|
| 开发者（上传者） | 把任意 Word 变成通用 CSS 模板 | 复制即用，class 名与变量 100% 对齐设计规范 |
| 运营（审核者） | 肉眼确认还原效果 | 左侧 Word 分页缩略图与右侧 HTML 差异 ≤1 mm |

---

## 3. 功能清单（可验收）

| 编号 | 描述 | 验收要点 |
|---|---|---|
| F0 | 上传 .docx（≤1 MB） | 拖拽/点击；超限即时红字提示；禁止 .doc |
| F1 | 解析并生成 HTML + CSS 模板 | css 字符串以 `/* Word2CSS Template` 开头；HTML 带 `class="docx-*"` |
| F2 | 样式还原率 ≥98 % | 见第 9 章指标；豁免页眉/分页/OLE |
| F3 | 提取通用 CSS 模板 | 弹出模态框，文本框只读，可复制；JSON 结构 `{"template_content":"..."}` |
| F4 | 并排对比视图 | 左：PDF 画布缩略图（分页准确）；右：HTML；同步滚动 |
| F5 | 一键下载 | zip 含 `index.html` + `template.css` + `images/`；离线打开样式一致 |
| F6 | 失败回显 | 解析失败高亮段落 + 提供“下载原文件”按钮 |

---

## 4. 非功能需求

| 维度 | 指标 |
|---|---|
| 性能 | 上传→解析→渲染 ≤3 s（冷启动含） |
| 并发 | 2 人同时上传无队列 |
| 体积 | 前端新增 gzip ≤1.2 MB（pdfjs 精简） |
| 兼容 | Chrome/Edge 最新两版；Word≥2007、WPS2019+ |
| 安全 | 不存盘；不落库；HTTPS only；CORS 严格同源 |
| 可访问 | 按钮 aria-label；toast 用 role=status |

---

## 5. 技术约束
- 前端：使用现有技术栈  
- 不修改现有代码，是新增的页面

---

## 6. 接口契约

### 6.1 `/api/parse`（Edge Function）
**Request**  
`POST` multipart/form-data  
field: `file=.docx` (≤1 MB)

**Response 200**  
```json
{
  "html": "<section class='docx-page'>…</section>",
  "css": "/* Word2CSS Template… */",
  "pdf": "data:application/pdf;base64,…",   // 仅用于对比视图
  "images": [{"name":"image1.png","data":"base64,…"}]
}
```

**Error 422**  
```json
{"error": "Paragraph 3: unsupported w:vAlign"}
```

### 6.2 前端 Hook
```ts
const { parseDocx } = useParseDocx();
const { html, css, pdf } = await parseDocx(file);
```

---

## 7. 关键算法 / 数据流

1. **前端上传** → FileReader → SHA256（缓存 key）  
2. **Edge Function**  
   a. `yauzl` 流式解压  
   b. `mammoth` + `styleMapper.ts`（精调映射表）→ 初步 HTML + CSS  
   c. `libreoffice-convert`（LO headless）→ PDF（缓存 1 h）  
   d. 返回 JSON  
3. **前端渲染**  
   - 左侧 `<canvas id="pdf-canvas">` + pdfjs textLayer  
   - 右侧 `dangerouslySetInnerHTML={{__html: html}}`  
   - 同步滚动：监听 `scrollLeft/Top` 比例互写

---

## 8. 样式规范（CSS 模板）
与 `t.html` 设计系统 100% 对齐：  
- 前缀 `.docx-`；变量全部使用 `:root` 自定义属性  
- 表格、高亮块、RTL、hr、blockquote 全部输出对应 class  
- 禁止行内 style；禁止 id 选择器  
- 文件头注释含时间戳 & 使用提示（复制即用）
提取出来的样式如下：
```css
/* Word2CSS Template - generated at 2025-09-16T14:23:12.345Z */
/* IMPORTANT: Do not modify this stylesheet in any way unless explicitly instructed */
/* IMPORTANT - When dealing with Arabic text, employ lang="ar" and dir="rtl" and make any headings that use "border-left:" to be "border-right:" to ensure they display on the right side of the page and align with the Arabic text.*/

@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&family=Lato:wght@400;500;600;700&display=swap');

:root {
  --text-color: #333333;
  --h1-color: #FFFFFF;
  --h2-color: #FFFFFF;
  --h3-color: #1A1A1A;
  --h4-color: #333333;
  --h5-color: #555555;
  --h6-color: #777777;

  --gold-primary: #B8860B;
  --gold-accent: #DAA520;
  --gold-light: #FFFACD;

  --black-primary: #1A1A1A;
  --black-light: #333333;

  --accent-color: var(--gold-primary);
  --secondary-color: var(--black-primary);
  --quaternary-color: var(--black-light);

  --table-row-color: #F8F8F8;
  --background-color: #FFFFFF;

  --primary-font: 'Lato', sans-serif;
  --heading-font: 'Cinzel', serif;
}

body {
  font-family: var(--primary-font);
  color: var(--text-color);
  box-sizing: border-box;
  background-color: var(--background-color);
  line-height: 1.5;
}

/* Heading 1 */
.docx-h1 {
  font-family: var(--heading-font);
  font-size: 24pt;
  font-weight: 700;
  text-align: center;
  margin-bottom: 0.2in;
  position: relative;
  color: var(--h1-color);
  padding: 15px 25px;
  background: linear-gradient(135deg, var(--black-primary), var(--black-light));
  border-radius: 10px;
  border: 2px solid var(--gold-primary);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.docx-h1::after {
  content: "";
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 4px;
  background: var(--gold-accent);
  border-radius: 2px;
}

/* Default paragraph */
.docx-p-default {
  margin: 0 0 6pt 0;
  font-family: var(--primary-font);
  color: var(--text-color);
  line-height: 1.5;
}

/* Table */
.docx-table {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
  margin-bottom: 40px;
  border: 2px solid var(--gold-primary);
  border-radius: 8px;
  overflow: hidden;
}
.docx-table th,
.docx-table td {
  word-wrap: break-word;
  overflow-wrap: break-word;
  max-width: 1px;
  border: 1px solid var(--gold-light);
  padding: 12px 4px;
  font-size: 10pt;
  text-align: center;
}
.docx-table th {
  color: #fff;
  background: var(--black-primary);
  font-weight: 500;
  text-transform: uppercase;
}
.docx-tr-odd {
  background-color: var(--table-row-color);
}

/* 其他通用元素 */
.docx-a {
  color: var(--gold-primary);
  text-decoration: none;
  font-weight: 500;
  border-bottom: 1px solid var(--gold-accent);
}
.docx-blockquote {
  font-style: italic;
  border-left: 4px solid var(--gold-primary);
  padding-left: 15px;
  margin-left: 0;
  background: var(--table-row-color);
  padding: 15px 15px 15px 25px;
  border-radius: 0 8px 8px 0;
}
.docx-hr {
  border: none;
  height: 2px;
  background: linear-gradient(90deg, var(--gold-primary), var(--gold-accent), var(--gold-primary));
  margin: 30px 0;
  border-radius: 1px;
}
```

## 12. UI页面高清结构（新增章节，已嵌入V2.2）

### 12.1 布局总览
| 区域 | 占比 | 说明 |
|---|---|---|
| 顶部导航栏 | h-16 | 已存在项目通用Header，**不改动** |
| 主工作区 | h-[calc(100vh-4rem)] | 本页独占，左右分栏，下方浮动工具条 |

### 12.2 组件级拆解
```
┌───────────────────────── 顶部导航栏（已存在） ───────────────────────────┐
│  [Logo]  |  导航菜单  |  当前位置：工具 > Word提取器   |  用户头像        │
├───────────────────────── 主工作区（新页面独享） ─────────────────────────┤
│  Left  w-1/2  bg-gray-50  |  Right  w-1/2  bg-white  border-l          │
│  ┌─ 上传区 ──────────────┐│  ┌─ 工具栏 ───────────────────┐            │
│  │  ▶ 拖拽或点击上传      ││  │  复制CSS  下载  帮助(?)]  │  高 28px   │
│  │  .docx ≤1 MB          ││  └────────────────────────────┘            │
│  └───────────────────────┘│  ┌─ 预览区 ───────────────────┐            │
│  ┌─ 分页缩略图列表 ──────┐│  │  iframe 实际渲染            │  高自适应  │
│  │  ① ② ③… 小图+页码    ││  │  （隔离样式）               │            │
│  │  当前页高亮蓝框        ││  │                              │            │
│  └───────────────────────┘│  └────────────────────────────┘            │
│                            │  ┌─ 底部浮动条 ───────────────┐            │
│                            │  │  解析耗时 1.2s  |  节点数 42  │  高 36px   │
│                            │  └────────────────────────────┘            │
└──────────────────────────────────────────────────────────────────────────┘
```

### 12.3 各组件像素级描述
| 组件 | 类名/样式 | 交互 |
|---|---|---|
| 上传区 DropZone | 固定高 180px，圆角 `rounded-xl`，拖入时 `border-blue-400 dashed` | 拖入/点击→打开文件选择 |
| 分页缩略图 | 宽 120px，高 160px，object-cover，当前页 `ring-2 ring-blue-500` | 点击→右侧同步滚动到对应页 |
| 工具栏 | `sticky top-0 z-10 bg-white/90 backdrop-blur` | 复制CSS→toast；下载→zip |
| 预览 iframe | `sandbox="allow-same-origin"`，src 用 `srcdoc={html}` | 隔离样式，防止污染主站 |
| 底部浮动条 | `sticky bottom-0 z-10` | 解析完成后显示耗时 & 节点计数 |
| 失败提示 | 红色高亮卡片，提供“下载原文件”按钮 | 点击→原文件落本地 |

### 12.4 响应式断点
- ≥1280px：左右 5:5 分栏  
- 768-1279px：上下布局，上传区置顶，预览区全宽  
- <768px：隐藏缩略图列表，仅保留“上传+预览”两区

### 12.5 暗黑模式
- 首版不做；CSS 模板已用变量，后续只需在 `:root` 换色即可

### 12.6 关键帧 & 过渡
- 拖入时：DropZone 边框颜色 200ms ease-in-out  
- 解析中：上传区蒙层 `backdrop-blur-sm` + spinner  
- 复制成功：toast 从底部滑入 300ms

---

## 13. 最终交付物（含 UI）
1. 需求文档 V2.2（= 本文档，已含 UI 章节）  
2. `/src/app/word-to-css.tsx` 完整页面源码   
3. Tailwind 类名清单 + 自定义 css 变量文件  
4. Storybook 故事文件，可离线看 UI 状态  
5. 像素对比测试脚本（HeadlessChrome + pixelmatch）

---
